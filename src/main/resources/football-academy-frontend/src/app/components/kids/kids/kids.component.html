<div class="container-fluid mt-4">
  <h2>Kids Management</h2>
  <div *ngIf="loading" class="alert alert-info">Loading...</div>
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

  <div *ngIf="isAdminOrSuperAdmin()" class="mb-3">
    <h3>Search Kids</h3>
    <form [formGroup]="searchForm" (ngSubmit)="searchKids()">
      <div class="row">
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="First Name" formControlName="firstName">
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="Last Name" formControlName="lastName">
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="Parent Name" formControlName="parentName">
        </div>
        <div class="col-md-2">
          <select class="form-control" formControlName="status">
            <option value="">All Statuses</option>
            <option value="ACTIVE">Active</option>
            <option value="INACTIVE">Inactive</option>
            <option value="SUSPENDED">Suspended</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary" [disabled]="loading">Search</button>
        </div>
      </div>
    </form>
  </div>

  <div *ngIf="isAdminOrSuperAdmin()" class="mb-3">
    <h3>Add Kid</h3>
    <form [formGroup]="addKidForm" (ngSubmit)="addKid()">
      <div class="row">
        <div class="col-md-2">
          <select class="form-control" formControlName="parentId"
            [ngClass]="{'is-invalid': addKidForm.get('parentId')?.touched && addKidForm.get('parentId')?.invalid}">
            <option value="">Select Parent</option>
            <option *ngFor="let parent of parents" [value]="parent.userId">
              {{ parent.firstName }} {{ parent.lastName }} ({{ parent.email }})
            </option>
          </select>
          <div class="invalid-feedback">Parent is required</div>
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="First Name" formControlName="firstName"
            [ngClass]="{'is-invalid': addKidForm.get('firstName')?.touched && addKidForm.get('firstName')?.invalid}">
          <div class="invalid-feedback">First Name is required</div>
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" placeholder="Last Name" formControlName="lastName"
            [ngClass]="{'is-invalid': addKidForm.get('lastName')?.touched && addKidForm.get('lastName')?.invalid}">
          <div class="invalid-feedback">Last Name is required</div>
        </div>
        <div class="col-md-2">
          <input type="date" class="form-control" formControlName="dateOfBirth"
            [ngClass]="{'is-invalid': addKidForm.get('dateOfBirth')?.touched && addKidForm.get('dateOfBirth')?.invalid}">
          <div class="invalid-feedback">Date of Birth is required</div>
        </div>
        <div class="col-md-2">
          <input type="date" class="form-control" formControlName="enrollmentDate"
            [ngClass]="{'is-invalid': addKidForm.get('enrollmentDate')?.touched && addKidForm.get('enrollmentDate')?.invalid}">
          <div class="invalid-feedback">Enrollment Date is required</div>
        </div>
      </div>

      <div class="mt-3">
        <h4>Fee Details</h4>
        <button type="button" class="btn btn-secondary mb-2" (click)="addFeeDetail()">Add Fee</button>

        <div *ngFor="let feeDetail of feeDetails.controls; let i = index" class="row mb-2" [formGroup]="$any(feeDetail)">
          <div class="col-md-2">
            <input type="text" class="form-control" placeholder="Description" formControlName="description"
              [ngClass]="{'is-invalid': feeDetail.get('description')?.touched && feeDetail.get('description')?.invalid}">
            <div class="invalid-feedback">Description is required</div>
          </div>
          <div class="col-md-2">
            <select class="form-control" formControlName="chargeType"
              [ngClass]="{'is-invalid': feeDetail.get('chargeType')?.touched && feeDetail.get('chargeType')?.invalid}">
              <option value="">Select Fee Type</option>
              <option *ngFor="let feeType of feeTypes" [value]="feeType">{{ feeType }}</option>
            </select>
            <div class="invalid-feedback">Fee Type is required</div>
          </div>
          <div class="col-md-2">
            <select class="form-control" formControlName="itemType"
              [ngClass]="{'is-invalid': feeDetail.get('itemType')?.touched && feeDetail.get('itemType')?.invalid}">
              <option value="">Select Item Type</option>
              <option *ngFor="let type of itemTypes" [value]="type">{{ type }}</option>
            </select>
            <div class="invalid-feedback">Please select an item type.</div>
          </div>
          <div class="col-md-2">
            <input type="number" class="form-control" placeholder="Amount" formControlName="amount"
              [ngClass]="{'is-invalid': feeDetail.get('amount')?.touched && feeDetail.get('amount')?.invalid}">
            <div class="invalid-feedback">Valid amount is required</div>
          </div>
          <div class="col-md-2">
            <select class="form-control" formControlName="recurrenceInterval"
              [ngClass]="{'is-invalid': feeDetail.get('recurrenceInterval')?.touched && feeDetail.get('recurrenceInterval')?.invalid}"
              [disabled]="feeDetail.get('chargeType')?.value === 'ONE_OFF'">
              <option value="">Select Interval</option>
              <option *ngFor="let interval of recurrenceIntervals" [value]="interval">{{ interval }}</option>
            </select>
            <div class="invalid-feedback">Recurrence Interval is required for recurring fees</div>
          </div>
          <div class="col-md-2">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" formControlName="prorate"
                [disabled]="feeDetail.get('chargeType')?.value === 'ONE_OFF'">
              <label class="form-check-label">Prorate First Billing</label>
            </div>
          </div>
          <div class="col-md-2" *ngIf="feeDetail.get('chargeType')?.value === 'ONE_OFF'">
            <input type="date" class="form-control" formControlName="dueDate">
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm" (click)="removeFeeDetail(i)">Remove</button>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary" [disabled]="addKidForm.invalid || loading">Add Kid</button>
      </div>
    </form>
  </div>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Code</th>
        <th>Name</th>
        <th>Date of Birth</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let kid of kids">
        <td>{{ kid.code }}</td>
        <td>{{ kid.firstName }} {{ kid.lastName }}</td>
        <td>{{ kid.dateOfBirth | date }}</td>
        <td>
          <select *ngIf="isAdminOrSuperAdmin()" [(ngModel)]="kid.status" (change)="updateStatus(kid)"
            [ngModelOptions]="{standalone: true}">
            <option value="ACTIVE">Active</option>
            <option value="INACTIVE">Inactive</option>
            <option value="SUSPENDED">Suspended</option>
          </select>
          <span *ngIf="!isAdminOrSuperAdmin()">{{ kid.status }}</span>
        </td>
        <td>
          <button *ngIf="isAdminOrSuperAdmin()" class="btn btn-sm btn-warning me-2"
            (click)="openEditDialog(kid)">Edit</button>
          <button class="btn btn-sm btn-primary me-2" (click)="openDetailsDialog(kid)">View Details</button>
          <button *ngIf="isAdminOrSuperAdmin()" class="btn btn-sm btn-danger"
            (click)="deleteKid(kid.kidId)">Delete</button>
        </td>
      </tr>
    </tbody>
  </table>

  <div *ngIf="isAdminOrSuperAdmin()" class="mb-3">
    <h3>Kids with Outstanding Balances</h3>
    <form [formGroup]="outstandingForm" (ngSubmit)="loadOutstandingBalances()">
      <div class="row">
        <div class="col-md-6">
          <input type="number" class="form-control" placeholder="Parent ID (optional)" formControlName="parentId">
        </div>
        <div class="col-md-6">
          <input type="date" class="form-control" placeholder="Due Date Before (optional)"
            formControlName="dueDateBefore">
        </div>
      </div>
      <button type="submit" class="btn btn-primary mt-2" [disabled]="loading">Load Outstanding Balances</button>
    </form>
    <table *ngIf="kidBalances.length > 0" class="table table-striped">
      <thead>
        <tr>
          <th>Kid ID</th>
          <th>Name</th>
          <th>Outstanding Balance</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let kb of kidBalances">
          <td>{{ kb.kidId }}</td>
          <td>{{ kb.kidName }}</td>
          <td>{{ kb.outstandingBalance | currency }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="isAdminOrSuperAdmin() && (recentInvoices.length > 0 || recentSchedules.length > 0)" class="mb-3">
    <h3>Recent Invoices and Billing Schedules</h3>
    <table class="table table-striped" *ngIf="recentInvoices.length > 0">
      <thead>
        <tr>
          <th>Invoice ID</th>
          <th>Kid</th>
          <th>Items</th>
          <th>Amount</th>
          <th>Due Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of recentInvoices">
          <td>{{ invoice.invoiceNumber }}</td>
          <td>{{ invoice.kidName }}</td>
          <td>
            <ng-container *ngFor="let item of invoice.items">
              {{ item.description }} ({{ item.amount | currency }})<br>
            </ng-container>
          </td>
          <td>{{ invoice.amount | currency }}</td>
          <td>{{ invoice.dueDate | date }}</td>
          <td>{{ invoice.status }}</td>
        </tr>
      </tbody>
    </table>
    <table class="table table-striped" *ngIf="recentSchedules.length > 0">
      <thead>
        <tr>
          <th>Schedule ID</th>
          <th>Kid</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Due Date</th>
          <th>Recurrence</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let schedule of recentSchedules">
          <td>{{ schedule.billingScheduleId }}</td>
          <td>{{ schedule.kidName }}</td>
          <td>{{ schedule.description }}</td>
          <td>{{ schedule.amount | currency }}</td>
          <td>{{ schedule.dueDate | date }}</td>
          <td>{{ schedule.recurrenceInterval }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>